<%content_for :link do%>
  <li><a href="/">HUFS</a></li>
<%end%>
<%content_for :search_form do%>
<nav class="nav_form">
  <div class="nav-wrapper white">
    <form action="/rests">
      <div class="input-field">
        <input id="search" type="search" name="q" required>
        <label for="q"><i class="material-icons">search</i></label>
        <i class="material-icons closer">close</i>
      </div>
    </form>
  </div>
</nav>
<%end%>
<%content_for :tabs do %>
<ul class="tabs navi tabs-transparent ohome">
<%=tab_lists%>
</ul>
<%end%>
<div class="row">
  <div class="col s12 m10 offset-m1 l8 offset-l2">
    <div class="card">
      <div class="card-content" id="map" style="height:300px;"></div>
    </div>
  </div>
   
  <div class="col s12 m10 offset-m1 l8 offset-l2">
    <ul class="collection with-header">
      <%if params[:q]%><li class="collection-header"><h5><%if @restCategoryHash[@q]%><%=@restCategoryHash[@q][@language]%><%else%><%=@q%><%end%></h5></li><%end%>
      <%@list.each do |re|%>
      <li class="collection-item avatar">
        <%if re.picture==nil||re.picture==""%><i class="material-icons red lighten-3 circle">restaurant</i><%else%><img src="<%='http'+re.picture.split('http')[1]%>" alt="" class="circle"><%end%>
        <span class="title"><a href="/rests/<%=re.id%><%if params[:q]%>?index=<%=@q%><%end%>"><%=highlight(re.name,@q)%></a></span>
        <p>
          <%if (re.food.include? @q)||(re.name.include? @q)%>
            <%if re.re_menu%>
              <%if @language==4%>
                <%=re.re_menu%>
              <%elsif @language==0%>
                <%=re.ere_menu.titleize%>
              <%else%>
                <%=re.chinese%>
              <%end%>
            <%else%>
            Welcome to the Restaurant!
            <%end%>
          <%else%>
            <%temp = re.rmenu.where("lower(menuname) like ? or lower(emenuname) like ? or lower(cmenuname) like ?","%#{@q.to_s.downcase}%","%#{@q.to_s.downcase}%","%#{@q.to_s.downcase}%").order(:pagenum)%>
            <%if temp.length>0%>
              <%if temp[0].menuname.downcase.include? @q.downcase%>
                <%=highlight(temp[0].menuname.downcase, @q.downcase)%>
              <%elsif temp[0].emenuname.downcase.include? @q.downcase%>
                <%=highlight(temp[0].emenuname.downcase, @q.downcase)%>
              <%else%>
                <%=highlight(temp[0].cmenuname.downcase, @q.downcase)%>
              <%end%>
            <%end%>
          <%end%>
        </p>
        <div class="secondary-content grey-text favorite" style="display: none;" data-id="<%=re.id%>" data-name="<%=re.name%>" ><i class="material-icons">star_border</i></div>
      </li>
      <%@all[re.map].append(re)%>
      <%end%>
    </ul>
  </div>
    
  
</div>        

<div class="fixed-action-btn click-to-toggle" style="bottom: 14px; right: 14px;">
  <a class="btn-floating btn-large scale-btn scrollUp red">
    <i class="material-icons addbtn" data-angle="0">translate</i>
  </a>
  <ul>
    <%=oLan_button%>
  </ul>
</div>
<script src="//apis.daum.net/maps/maps3.js?apikey=23598cdf36f0c5f5bf1f1bfda70b8e80&libraries=services"></script>
<script>
  $(document).ready(function(){
    $('.addbtn').on('click',function(){
      var $this=$(this);
      var word= $this.html()=='translate' ? 'clear' : 'translate' 
      var angle=$this.data('angle')+90;
      $this.velocity(
        {rotateY: angle+'deg'},
        {duration: 250,
          complete: function(){
            angle+=90
            $(this).html(word).velocity({rotateY: angle+'deg'},{duration: 250})
            $this.data('angle',angle);
          }
        }
      );
    });
    var lastScrollTop = 0;
    var $scaleBtn=$('.scale-btn');
    $scaleBtn.velocity({scaleX: 1,scaleY: 1});
    $(window).scroll(function(event){
      var st = $(this).scrollTop();
      if (st -lastScrollTop>14 &&$scaleBtn.hasClass('scrollUp')){
        $scaleBtn.velocity({scaleX: 0,scaleY: 0},{duration: 10}).removeClass('scrollUp').addClass('scrollDown');
        if($scaleBtn.parent().hasClass('active'))$scaleBtn.trigger('click').addClass('opened');
        lastScrollTop = st;
      }
      else if(st-lastScrollTop< -14&&$scaleBtn.hasClass('scrollDown')){
        var com=null;
        if($scaleBtn.hasClass('opened')){
          $scaleBtn.removeClass('opened');
          com=function(){
            $scaleBtn.trigger('click');
          };
        }
        $scaleBtn.removeClass('scrollDown').addClass('scrollUp').velocity({scaleX: 1,scaleY: 1},{duration: 10,complete: com});
        lastScrollTop = st;
      }
      if(st-lastScrollTop>14||st-lastScrollTop<-14) lastScrollTop=st;
    });
    $('.modal').modal({
      ready: function(){
        $('.button-collapse').sideNav('hide');
      }
    });
    $(".button-collapse").sideNav();
    $(".opener").click(function(){
      $(".main_nav").hide();
      $(".nav_form").fadeIn();
      document.getElementById("search").focus();
    })
    $(".closer").click(function(){
      $(".nav_form").hide();
      $(".main_nav").fadeIn();
    })
    $("ul.tabs").tabs();
    if(window.Hybrid&&window.Hybrid.favoriteInit){
      var count = 1;
      $('.favorite').each(function(){
        var $this=$(this);
        $this.show();
        if(window.Hybrid.favoriteInit($this.data("id"),$this.data("name"))=="1"){
          $this.removeClass('grey-text').find('i').html('star');
          $( "ul.collection > li:nth-child("+count+")" ).before($this.parent());
          count=count+1;
        }
      })
      $(".favorite").click(function(){
        var $this=$(this);
        if($this.hasClass('grey-text')){
          $this.removeClass('grey-text').find('i').html("star");
          window.Hybrid.favOn($this.data('id'), $this.data("name"), "<%=@current_language%>");
        }
        else{
          $this.addClass('grey-text').find('i').html('star_border');
          window.Hybrid.favOff($this.data('id'), $this.data("name"), "<%=@current_language%>");
        }
      })
    }
  })
	var container = document.getElementById('map');
	var option = {
	  center: [37.596418,127.060246],
		level: 3
	};
	var easyMap=own.EasyMap

	var map =new own.DaumMap(container, option);

  var markers=[];
  var overlays=[];
  <%@all.each do |key, value|%>
    markers.push(new own.Marker({
      position: [<%=key.lat%>,<%=key.lon%>],
      map: map,
      clickable: true
    }));
    overlays.push(new own.CustomOverlay({
      content: '<div class="placeinfo_wrap"><div class="placeinfo"><%value.each do |r|%><a class="ptitle" href="/rests/<%=r.id%>"><%=r.name%></a><%end%>'+
                '<span>'+
                '<span style="text-align: right;" class="material-icons close" aria-hidden="true">clear</span>'+
                '</span></div>'+
                '<div class="after"></div></div>',
      clickable: true
    }));
  <%end%>
  easyMap.customOverlayOnClose(overlays,'overlays');
  easyMap.markerClickOpen(markers,overlays);
</script>